<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot de Consentimento (Demo)</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; background: #f4f4f4; }
        
        
        #audit-box {
            background: #eef; border: 1px solid #bdf; padding: 15px;
            margin-top: 20px; border-radius: 8px;
        }
        #audit-box form { display: flex; align-items: center; }
        #audit-box label { font-weight: bold; margin-right: 10px; }
        #audit-box input { flex-grow: 1; padding: 8px; font-size: 1em; }
        #audit-box button {
            padding: 9px 15px; font-size: 1em; color: white; margin-left: 10px;
            background-color: #555; border: none; border-radius: 4px; cursor: pointer;
        }
        #user-sim-box { 
            background: #fff; border: 1px solid #ccc; padding: 15px; 
            margin-bottom: 15px; border-radius: 8px; 
        }
        #user-sim-box label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px; }
        #user-sim-box input { width: 95%; padding: 8px; font-size: 1em; border: 1px solid #ddd; }

        #chat-window { height: 400px; border: 1px solid #ccc; background: #fff; padding: 10px; overflow-y: scroll; }
        .bot { color: #007bff; margin-bottom: 10px; }
        .user { text-align: right; color: #333; margin-bottom: 10px; }
        #controls { display: flex; margin-top: 10px; }
        #controls button { padding: 10px; font-size: 16px; cursor: pointer; border: none; flex-grow: 1; }
        #btn-aceitar { background: #28a745; color: white; }
        #btn-recusar { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>Demonstração da Arquitetura de Consentimento</h1>
    <div id="audit-box">
        <form action="/audit" method="GET" target="_blank">
            <label for="audit-user-id">Auditar Usuário:</label>
            <input type="text" id="audit-user-id" name="user_id" placeholder="Digite um ID de usuário...">
            <button type="submit">Ver Logs</button>
        </form> 
    </div>

    <div id="user-sim-box">
        <label for="user-id-input">Simulação de Login (ID do Usuário Logado):</label>
        <input type="text" id="user-id-input" value="123">
    </div>

    <div id="chat-window">
        <div class="bot">Olá! Eu sou o assistente de demonstração da arquitetura de microsserviços para gestão de consentimento.</div>
    </div>
    <div id="controls">
        <button id="btn-aceitar" disabled>Aceitar</button>
        <button id="btn-recusar" disabled>Recusar</button>
    </div>

    <script>        
        let ID_POLITICA_ATUAL = null;

        // --- Elementos do DOM ---
        const chatWindow = document.getElementById('chat-window');
        const btnAceitar = document.getElementById('btn-aceitar');
        const btnRecusar = document.getElementById('btn-recusar');
        const userIdInput = document.getElementById('user-id-input');

        // --- Funções do Chat ---
        function addMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = sender;
            msgDiv.innerHTML = text;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function fetchLatestPolicy() {
            try {
                const response = await fetch('/get-latest-policy'); 
                const data = await response.json();

                if (response.ok) {
                    ID_POLITICA_ATUAL = data.id;
                    const policyLink = `<a href="${data.s3_url}" target="_blank">Política de Privacidade (Versão ${data.version})</a>`;
                    addMessage('bot', `Para continuar, preciso do seu consentimento.<br><br>Por favor, leia nossa ${policyLink}.<br><br>Você aceita os termos?`);
                    btnAceitar.disabled = false;
                    btnRecusar.disabled = false;
                } else {
                    addMessage('bot', `Erro ao buscar política: ${data.error}`);
                }
            } catch (err) {
                addMessage('bot', 'Erro de conexão ao buscar política.');
            }
        }

        async function registerConsent(aceitou) {
            btnAceitar.disabled = true;
            btnRecusar.disabled = true;
            
            const userId = userIdInput.value; // Pega o ID do campo de texto
            if (!userId) {
                addMessage('bot', 'Erro: Por favor, informe um ID de usuário para a simulação.');
                btnAceitar.disabled = false;
                btnRecusar.disabled = false;
                return;
            }

            if (aceitou) {
                addMessage('user', 'Eu aceito.');
                addMessage('bot', 'Obrigado! Registrando seu consentimento...');
            } else {
                addMessage('user', 'Eu recuso.');
                addMessage('bot', 'Entendido. Registrando sua recusa...');
            }

            try {
                const response = await fetch('/register-consent', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id_user: parseInt(userId), 
                        id_policy: ID_POLITICA_ATUAL,
                        channel: 'chatbot_demo_frontend',
                        status: aceitou ? 'given' : 'refused'
                    })
                });
                
                const data = await response.json();

                if (response.ok) {
                    addMessage('bot', `<b>Registro efetuado com sucesso!</b><br>ID do Recibo: ${data.consent.id}<br>Status: ${data.consent.status}`);
                } else {
                    addMessage('bot', `Erro ao registrar: ${data.error}`);
                }
            } catch (err) {
                addMessage('bot', 'Erro de conexão ao registrar.');
            }
        }

        // --- Event Listeners ---
        btnAceitar.onclick = () => registerConsent(true);
        btnRecusar.onclick = () => registerConsent(false);

        // --- Iniciar Chat ---
        fetchLatestPolicy();
    </script>
</body>
</html>
